# [gcode_macro SHAPE_TIP]
# description: Perform tip-shaping, retraction, and cooling moves
# gcode:
#     SAVE_GCODE_STATE NAME=Shape_Tip_state
#     M83 # extruder relative mode
    
#     # gcode generated by SuperSlicer, with XY moves removed
#     ;--------------------
#     ; CP TOOLCHANGE START
#     ; toolchange #1
#     ; material : PLA -> PLA
#     ;--------------------
#     M220 S100
#     ; CP TOOLCHANGE UNLOAD
#     ;WIDTH:0.65
#     # G1  X66.273 Y170.819  
#     SET_PRESSURE_ADVANCE ADVANCE=0
#     G1 F68
#     G1 E0.2816
#     G1 F73
#     G1 E0.3051
#     G1 F83
#     G1 E0.3453
#     G1 F96
#     G1 E0.399
#     G1 F114
#     G1 E0.4761
#     G1 F138
#     G1 E0.5767
#     G1 F163
#     G1 E0.5691
#     # G1  Y170.039  F7200
#     G1 F162
#     G1 E0.1081
#     G1 F196
#     G1 E0.7644
#     G1 F186
#     G1 E0.8248
#     G1 F203
#     G1 E0.8483
#     ;WIDTH:0.5
#     G1 E-15 F6000
#     G1 E-15.4 F5400
#     G1 E-4.4 F2700
#     G1 E-2.2 F1620
#     # G1  Y169.259 
#     G1 E14 F1200
#     G1 E-14
#     G1 E14
#     G1 E-14
#     G1 E14
#     G1 E-14
#     G1 E14
#     G1 E-14
#     ; SKINNYDIP START
#     G1 E24 F1980
#     G4 P0
#     G1 E-24 F4200
#     G4 P0
#     ; SKINNYDIP END
#     G1 F2000
#     # G1  Y169.399  F2400
#     G4 S0
#     ; custom gcode: end_filament_gcode
#     ; Filament-specific end gcode 
#     ;END gcode for filament
#     ; custom gcode end: end_filament_gcode

#     RESTORE_GCODE_STATE NAME=Shape_Tip_state

[gcode_macro WIPE_NOZZLE]
gcode:
  G1 X125.00 Y255 F18000
  G1 X184.00 Y255 F18000
  {% for i in range(3) %}
  G1 X184.00 Y255 F9000
  G1 X244 Y255 F9000
  {% endfor %}


[gcode_macro RUNOUT]
gcode:
    M117 Runout!!!



[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
gcode:
    
    {% set X = params.X|default(240) %}
    {% set Y = params.Y|default(240) %}
    {% set Z = params.Z|default(10) %}
    {% set E = params.E|default(printer["gcode_macro _MACRO_VARIABLES"].retract) %}

    SAVE_GCODE_STATE NAME=PAUSE
    BASE_PAUSE
    SET_FILAMENT_SENSOR SENSOR=SFS ENABLE=0
    G91
    G1 E-{E} F1900
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F6000

    SET_LED_EFFECT EFFECT=paused REPLACE=1

[gcode_macro RESUME]
rename_existing: BASE_RESUME
gcode:
    {% set E = params.E|default(printer["gcode_macro _MACRO_VARIABLES"].retract) %}

    SET_LED LED=enclosure RED=0 GREEN=0 BLUE=0 white=1
    G91
    G1 E{E} F1900
    G90
    WIPE_NOZZLE
    SET_FILAMENT_SENSOR SENSOR=SFS ENABLE=1
    RESTORE_GCODE_STATE NAME=PAUSE MOVE=1
    BASE_RESUME

[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    SET_LED_EFFECT EFFECT=power_on REPLACE=1
    
    SET_FILAMENT_SENSOR SENSOR=SFS ENABLE=0
    #G1 E-7 F5000
    M140 S0
    M104 S0
    M106 S0
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT

# [gcode_macro SWAP_FILAMENT]
# gcode:
#     M117 Filament Change
#     SAVE_GCODE_STATE NAME=filament_change
#     PAUSE
#     UNLOAD_FILAMENT # unload
#     M117 Load new filament
#     COUNTDOWN TIME=60 MSG="Switch"
#     LOAD_FILAMENT
#     RESUME
#     RESTORE_GCODE_STATE NAME=filament_change
#     M117 Printing..

# [gcode_macro COUNTDOWN]
# default_parameter_MSG: "Time: "
# default_parameter_TIME: 10
# gcode: 
#     # countdown 
#     {% for s in range(TIME|int, 0, -1) %}
#         # dwell 1 second
#         G4 P1000
#         # echo
#         M117 {params.MSG} {s}s
#         #M118 {params.MSG} {s}s
#     {% endfor %}
